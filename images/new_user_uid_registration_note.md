# 新規ユーザーのUID取得と登録に関するメモ

## 1. 匿名認証のユーザーIDについて
匿名認証のユーザーIDは、セッションごとにランダムに割り振られるわけではありません。初回ログイン時に一意のUIDが生成され、デバイスのローカルストレージに保存されるため、同じデバイスから再度アクセスすれば同じ匿名UIDでログインできます。ただし、今回のケースではGoogle認証を使用しているため、この挙動は直接関係ありません。Google認証では、常に同じ一意のUIDが割り振られます。

## 2. 一度もアクセスしたことがない新規ユーザーのUID取得と登録方法

### 現状の理解
*   `@picocela.com`ドメインのGoogleアカウントであれば、Firebase Authenticationでの「認証」は成功し、Firebaseのユーザーリスト（Authenticationの「Users」タブ）にそのユーザーの情報（メールアドレス、UIDなど）が記録されます。
*   しかし、そのユーザーのUIDが`authorizedUsers`コレクションに登録されていないため、Firestore Security Rulesによって「認可」が拒否され、Firestoreへのデータアクセスはできません。

### 新規ユーザーのUID取得と登録フロー

1.  **新規ユーザーが初めてログインを試みる:**
    *   `@picocela.com`ドメインのGoogleアカウントであれば、Firebase Authenticationは成功します。
    *   アプリケーションはログイン成功と判断しますが、Firestoreへのデータアクセスを試みると、Security Rulesによって拒否されます。
    *   **アプリケーション側で、データアクセスが拒否された場合にユーザーにメッセージを表示する実装が必要です。**
        例：「アクセス権がありません。管理者に連絡してください。」

2.  **管理者がFirebaseコンソールで新規ユーザーのUIDを確認する:**
    *   Firebaseコンソールにアクセスし、「Authentication」の「Users」タブを開きます。
    *   そこに、ログインを試みた新規ユーザーのGoogleアカウント情報（メールアドレスなど）と、Firebaseによって割り振られた**UID**が表示されています。

3.  **管理者がそのUIDを`authorizedUsers`コレクションに手動で追加する:**
    *   FirebaseコンソールでFirestore Databaseに移動し、`authorizedUsers`コレクションを開きます。
    *   「ドキュメントを追加」ボタンをクリックし、先ほど確認した新規ユーザーのUIDをドキュメントIDとして追加します。フィールドは`placeholder: true`などで構いません。

4.  **新規ユーザーが再度ログインすると、データアクセスが可能になる:**
    *   `authorizedUsers`コレクションにUIDが追加された後、新規ユーザーが再度アプリケーションにアクセス（ログイン）すると、今度はSecurity Rulesの`isAuthorizedUser()`関数が`true`を返し、Firestoreへのデータアクセスが可能になります。

このフローにより、新規ユーザーのUIDを把握し、必要なユーザーのみにアクセス権を付与することが可能になります。
